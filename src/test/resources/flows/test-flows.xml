<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:db="http://www.mulesoft.org/schema/mule/db"
	xmlns:sfdc="http://www.mulesoft.org/schema/mule/sfdc"
	xmlns:json="http://www.mulesoft.org/schema/mule/json" xmlns="http://www.mulesoft.org/schema/mule/core"
	xmlns:doc="http://www.mulesoft.org/schema/mule/documentation"
	xmlns:spring="http://www.springframework.org/schema/beans" version="EE-3.6.0"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://www.mulesoft.org/schema/mule/db http://www.mulesoft.org/schema/mule/db/current/mule-db.xsd
http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-current.xsd
http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/sfdc http://www.mulesoft.org/schema/mule/sfdc/current/mule-sfdc.xsd
http://www.mulesoft.org/schema/mule/json http://www.mulesoft.org/schema/mule/json/current/mule-json.xsd">

	<sub-flow name="upsertUserInSalesforceFlow" >
         <sfdc:upsert config-ref="Salesforce" externalIdFieldName="Id" type="User" doc:name="Upsert user in Salesforce">

         </sfdc:upsert>
        <logger level="INFO" message="Update User in Salesforce result: #[payload]" doc:name="Logger"/>
    </sub-flow>
    
	<sub-flow name="updateUserInDatabaseFlow" >
                    <db:update config-ref="Database" bulkMode="true" doc:name="update users in Database">

                    </db:update>
        <logger level="INFO" message="Update User in B result: #[payload]" doc:name="Logger"/>
    </sub-flow>
    
    <sub-flow name="queryUserFromSalesforceFlow" >
        <sfdc:query-single config-ref="Salesforce" query="SELECT Id, Email, FirstName, LastName, Alias, Title, TimeZoneSidKey, LocaleSidKey, EmailEncodingKey, ProfileId, LanguageLocaleKey, CommunityNickname FROM User WHERE Email = '#[payload['Email']]'" doc:name="Query user from Salesforce"/>
        <logger level="INFO" message="Query user from A result: #[payload]" doc:name="Logger"/>
    </sub-flow>
    
    <sub-flow name="queryUserFromDatabaseFlow" >
                <enricher source="#[payload.isEmpty() ? NullPayload.getInstance() : payload[0]]" target="#[payload]" doc:name="store user">
                    <db:select config-ref="Database" doc:name="Query user from Database">

                    </db:select>
                    </enricher>
        <logger level="INFO" message="Query user from B result: #[payload]" doc:name="Logger"/>
    </sub-flow>
    <sub-flow name="insertUserInDatabaseFlow" >
        <logger message="insert: #[payload]" level="INFO" doc:name="Logger"/>
                    <db:insert config-ref="Database" bulkMode="true" doc:name="Insert user to Database">

                    </db:insert>
        <logger message="Insert user to B result: #[payload]" level="INFO" doc:name="Logger"/>
    
    </sub-flow>
    <sub-flow name="deleteUserFromSalesforceFlow" >
        <sfdc:delete config-ref="Salesforce" doc:name="Delete user from Salesforce">

        </sfdc:delete>
    </sub-flow>
    <sub-flow name="deleteUserFromDatabaseFlow" >
        <foreach doc:name="For Each">
            <db:delete config-ref="Database" doc:name="Delete user from Database">

            </db:delete>
        </foreach>
    </sub-flow>
    <sub-flow name="deleteUsersAfterSfdc2Database" >
        <foreach doc:name="For Each">
            <db:delete config-ref="Database" doc:name="Database">

            </db:delete>
        </foreach>
    </sub-flow>

</mule>
